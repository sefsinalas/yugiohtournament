<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tournament</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/picnic">
<style>
 body {
  font-family: Arial, sans-serif;
  margin: 20px;
  background: #f6f6f6;
 }

 .container {
  max-width: 1000px;
  margin: auto;
  display: flex;
  gap: 20px;
 }

 #leftPane { flex: 2; }
 #rightPane { flex: 1; }

 #rightPane table {
  width: 100%;
  border-collapse: collapse;
 }

 #rightPane th, #rightPane td {
  border-bottom: 1px solid #ddd;
  padding: 4px;
  text-align: left;
 }

h1 {
 text-align: center;
 margin-bottom: 20px;
}

h2 {
  margin-top: 0;
  margin-bottom: 10px;
  text-align: center;
}

 #timer {
  font-size: 2.5em;
  text-align: center;
  margin-bottom: 20px;
 }

 button {
  margin-right: 10px;
  margin-top: 5px;
 }

 ul {
  list-style-type: none;
  padding-left: 0;
 }

 li {
  padding: 8px 0;
  border-bottom: 1px solid #ddd;
 }

 li:last-child {
  border-bottom: none;
 }
</style>
</head>
<body>
<div class="container">
<div id="leftPane">
<h1>Tournament</h1>
<section class="card">
<div id="timer"></div>
<button id="newTournament">Start a New Tournament</button>
<button id="randomize">Randomize Pairings</button>
<button id="startRound" class="success">Start First Round</button>
</section>
<h2>Pairings of the first round</h2>
<section class="card">
<ul id="pairingsList"></ul>
</section>
<h2>Results</h2>
<section class="card" id="resultsSection"></section>
</div>
<div id="rightPane" class="card">
<h2>Tabla de Posiciones</h2>
<table id="scoreTable">
<thead>
<tr><th>#</th><th>Nombre</th><th>Puntos</th></tr>
</thead>
<tbody id="scoreTableBody"></tbody>
</table>
</div>
<script>
const PARTICIPANTS_KEY = 'participants';
const STARTED_KEY = 'tournamentStarted';
const PAIRINGS_KEY = 'pairings';
const RESULTS_KEY = 'round1Results';
const SCORES_KEY = 'round1Scores';

function loadParticipants() {
  const data = localStorage.getItem(PARTICIPANTS_KEY);
  if (!data) return [];
  try { return JSON.parse(data); } catch (e) { return []; }
}

function savePairings(pairings) {
  localStorage.setItem(PAIRINGS_KEY, JSON.stringify(pairings));
}

function loadResults() {
  const data = localStorage.getItem(RESULTS_KEY);
  return data ? JSON.parse(data) : {};
}

function saveResults(results) {
  localStorage.setItem(RESULTS_KEY, JSON.stringify(results));
}

function loadScores() {
  const data = localStorage.getItem(SCORES_KEY);
  return data ? JSON.parse(data) : {};
}

function saveScores(scores) {
  localStorage.setItem(SCORES_KEY, JSON.stringify(scores));
}

function getStarted() {
  return localStorage.getItem(STARTED_KEY) === 'true';
}

function setStarted(val) {
  localStorage.setItem(STARTED_KEY, val ? 'true' : 'false');
}

function randomizePairingsList(participants) {
  const shuffled = [...participants];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  const pairings = [];
  for (let i = 0; i < shuffled.length; i += 2) {
    const p1 = shuffled[i];
    const p2 = shuffled[i + 1] || { name: 'BYE' };
    pairings.push({ p1: p1.name, p2: p2.name });
  }
  return pairings;
}

function displayPairings(pairings) {
  const list = document.getElementById('pairingsList');
  list.innerHTML = '';
  pairings.forEach((p, idx) => {
    const li = document.createElement('li');
    li.textContent = `${idx + 1}. ${p.p1} vs ${p.p2}`;
    list.appendChild(li);
  });
}

function displayResults(pairings, results) {
  const container = document.getElementById('resultsSection');
  container.innerHTML = '';
  pairings.forEach((p, idx) => {
    const div = document.createElement('div');
    const label = document.createElement('span');
    label.textContent = `Match ${idx + 1}: `;
    div.appendChild(label);

    const b1 = document.createElement('button');
    b1.textContent = p.p1;
    const b2 = document.createElement('button');
    b2.textContent = p.p2;
    const draw = document.createElement('button');
    draw.textContent = 'Draw';

    const outcome = results[idx];
    if (outcome === 'p1') {
      b1.classList.add('success');
    } else if (outcome === 'p2') {
      b2.classList.add('success');
    } else if (outcome === 'draw') {
      draw.classList.add('success');
    }

    b1.addEventListener('click', () => recordResult(idx, 'p1'));
    b2.addEventListener('click', () => recordResult(idx, 'p2'));
    draw.addEventListener('click', () => recordResult(idx, 'draw'));

    div.appendChild(b1);
    div.appendChild(b2);
    div.appendChild(draw);
    container.appendChild(div);
  });
}

function displayScores(scores) {
  const body = document.getElementById('scoreTableBody');
  body.innerHTML = '';
  const entries = Object.entries(scores).sort((a, b) => b[1] - a[1]);
  entries.forEach(([name, pts], idx) => {
    const tr = document.createElement('tr');
    const pos = document.createElement('td');
    pos.textContent = idx + 1;
    const nm = document.createElement('td');
    nm.textContent = name;
    const sc = document.createElement('td');
    sc.textContent = pts;
    tr.appendChild(pos);
    tr.appendChild(nm);
    tr.appendChild(sc);
    body.appendChild(tr);
  });
}

function updateScores() {
  const scores = {};
  pairings.forEach((p, idx) => {
    if (!scores[p.p1]) scores[p.p1] = 0;
    if (!scores[p.p2]) scores[p.p2] = 0;
    const r = results[idx];
    if (r === 'p1') {
      scores[p.p1] += 3;
    } else if (r === 'p2') {
      scores[p.p2] += 3;
    } else if (r === 'draw') {
      scores[p.p1] += 1;
      scores[p.p2] += 1;
    }
  });
  saveScores(scores);
  displayScores(scores);
}

function recordResult(index, outcome) {
  results[index] = outcome;
  saveResults(results);
  updateScores();
  displayResults(pairings, results);
}

function startTimer(duration) {
  const timer = document.getElementById('timer');
  let remaining = duration;
  timer.textContent = formatTime(remaining);
  const interval = setInterval(() => {
    remaining--;
    timer.textContent = formatTime(remaining);
    if (remaining <= 0) {
      clearInterval(interval);
    }
  }, 1000);
}

function formatTime(seconds) {
  const m = Math.floor(seconds / 60).toString().padStart(2, '0');
  const s = (seconds % 60).toString().padStart(2, '0');
  return `${m}:${s}`;
}

const participants = loadParticipants();
let pairings = [];
let results = {};

function initialize() {
  pairings = localStorage.getItem(PAIRINGS_KEY);
  if (pairings) {
    try { pairings = JSON.parse(pairings); } catch (e) { pairings = []; }
    if (pairings.length && typeof pairings[0] === 'string') {
      pairings = pairings.map(str => {
        const parts = str.split(' vs ');
        return { p1: parts[0], p2: parts[1] || 'BYE' };
      });
      savePairings(pairings);
    }
  } else {
    pairings = [];
  }
  results = loadResults();
  displayPairings(pairings);
  displayResults(pairings, results);
  displayScores(loadScores());
  if (getStarted()) {
    document.getElementById('randomize').disabled = true;
  }
}

initialize();

document.getElementById('newTournament').addEventListener('click', () => {
  localStorage.removeItem(PAIRINGS_KEY);
  localStorage.removeItem(RESULTS_KEY);
  localStorage.removeItem(SCORES_KEY);
  setStarted(false);
  pairings = randomizePairingsList(participants);
  savePairings(pairings);
  results = {};
  displayPairings(pairings);
  displayResults(pairings, results);
  displayScores({});
  document.getElementById('randomize').disabled = false;
});

document.getElementById('randomize').addEventListener('click', () => {
  if (getStarted()) return;
  pairings = randomizePairingsList(participants);
  savePairings(pairings);
  results = {};
  saveResults(results);
  saveScores({});
  displayPairings(pairings);
  displayResults(pairings, results);
  displayScores({});
});

document.getElementById('startRound').addEventListener('click', () => {
  if (getStarted()) return;
  setStarted(true);
  document.getElementById('randomize').disabled = true;
  startTimer(45 * 60);
});
</script>
</div>
</body>
</html>
